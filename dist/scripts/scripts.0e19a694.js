"use strict";angular.module("thereApp",["ngAnimate","ngAria","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/people",{templateUrl:"views/people.html",controller:"PeopleCtrl",controllerAs:"people"}).when("/",{templateUrl:"views/appointments.html",controller:"AppointmentsCtrl",controllerAs:"appointments"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl",controllerAs:"loginCtrl"}).when("/session",{templateUrl:"views/session.html",controller:"SessionCtrl",controllerAs:"session"}).when("/createApptmt",{templateUrl:"views/createapptmt.html",controller:"CreateapptmtCtrl",controllerAs:"createApptmt"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location",function(a,b){a.$on("$locationChangeStart",function(b,c,d){a.session&&(a.session.off(),a.session.disconnect(),a.session=null)})}]).constant("_",_).constant("moment",moment),angular.module("thereApp").controller("AppointmentsCtrl",["$scope","$firebaseArray","$location","moment","api",function(a,b,c,d,e){function f(){var b=e.getRef("users");b.once("value",function(b){var c=b.val(),d=$.map(c,function(a,b){return[a]});console.log(d);for(var e=0;e<a.apps.length;e++)for(var f=0;f<d.length;f++)a.apps[e].client==d[f].userid&&(a.apps[e].imageurl=d[f].imageurl);a.$apply()})}a.apps=e.getArray("appointments"),a.apps.$ref().on("value",function(a){f()}),a.addAppointment=function(b,c){a.appointments.child(b).update(c)},a.addApp=function(){e.update("appointments",{therapist:"wriley",interpreter:"cnash",client:"adaniels",description:"This is a remote session yeah",startdate:d().add(7,"days").valueOf()})},a.addUser=function(){e.update("users",{name:"Anthony Daniel",role:"client",imageurl:"https://s3.amazonaws.com/there4u/anthonyd_LThumb.jpg"},"adaniel")},a.goToAppointment=function(a){c.path("/session").search({sessionid:a.sessionid})}}]),angular.module("thereApp").controller("MainCtrl",["$scope","$location",function(a,b){a.isActivePage=function(a){return b.path()===a}}]),angular.module("thereApp").controller("PeopleCtrl",function(){}),angular.module("thereApp").controller("SessionCtrl",["$scope","$rootScope","$location","$http","auth",function(a,b,c,d,e){function f(a,c,d){var e=OT.initSession(a,h);b.session=e,e.on({streamCreated:function(a){var b=a.stream.connection.data;console.log(b),"interpreter"==b.userrole?e.subscribe(a.stream,"theirCamDiv",{width:"100%",height:"100%",insertMode:"append"}):e.subscribe(a.stream,"mainCamDiv",{width:"100%",height:"100%"})}}),e.connect(d,function(a){a?console.log(a.message):e.publish("myCamDiv",{width:"100%",height:"100%"})})}var g="45548832",h="2_MX40NTU0ODgzMn5-MTQ1OTYwNDg0NDg0N35EU3U1cktYY2lhTEJHc3VPQTNXNFY4NGR-UH4";c.search().sessionid&&(h=c.search().sessionid);var i=e.getCurrentUser();i||(i={name:"fallback user",role:"interpreter"}),console.log(i),d({method:"GET",url:"https://refugeehackthere.herokuapp.com/gettoken",params:{sessionid:h,role:i.role}}).then(function(a){var b=a.data.token;f(g,h,b)},function(a){console.log(a.statusText);f(g,h)})}]),angular.module("thereApp").controller("CreateapptmtCtrl",["moment","api",function(a,b){}]),angular.module("thereApp").controller("LoginCtrl",["$scope","auth",function(a,b){console.log("cool"),a.login=b.login,console.log("dude")}]),angular.module("thereApp").service("api",["$firebaseArray","$q",function(a,b){function c(a){var b=new Firebase(i+a);return b}function d(b){var d=c(b);return a(d)}function e(a,d){var e=b.defer(),f=c(a);return d?f.child(d).once("value",function(a){var b=a.val();e.resolve(b)}):f.once("value",function(a){var b=a.val();e.resolve(b)}),e.promise}function f(a,d){var e=b.defer(),f=c(a);return d?f.child(d).once("value",function(a){e.resolve(a.exists())}):f.once("value",function(a){e.resolve(a.exists())}),e.promise}function g(a,d,e){var f=b.defer(),g=c(a);return e?g.child(e).update(d,function(a){a?(console.log(a),f.reject(a)):f.resolve()}):g.push().set(d,function(a){a?f.reject(a):f.resolve()}),f.promise}function h(a,b){var d=c(a);d.child(b).remove()}var i="https://there4you.firebaseio.com/";return{getRef:c,getArray:d,getValue:e,update:g,remove:h,exists:f}}]),angular.module("thereApp").service("auth",["api","$location",function(a,b){function c(c,d){console.log(c),a.exists("users",c).then(function(d){d?a.getValue("users",c).then(function(a){g=a,b.path("/appointments")}):a.update("users",{role:"therapist"},c).then(function(){a.getValue("users",c).then(function(a){g=a,b.path("/appointments")})})})}function d(){g=null}function e(){return g}function f(){return h}var g=null,h=null;return{login:c,logout:d,getCurrentUser:e,getCurrentSession:f}}]),angular.module("thereApp").filter("countdown",function(){return function(a){var b,c=moment.duration(moment(a)-moment());return b=0===c.days()?c.humanize():moment(a).format("MM/DD/YY, h:mm a")}}),angular.module("thereApp").directive("sessionNotes",function(){return{restrict:"EA",scope:{session:"=session"},templateUrl:"scripts/directives/session-notes/session-notes.html",controller:["$scope","api","moment","auth",function(a,b,c,d){a.addNote=function(e){b.update("notes",{sender:d.getCurrentUser(),text:message,createdAt:c().valueOf(),session:a.session})}}]}}),angular.module("thereApp").directive("sessionMessages",function(){return{restrict:"EA",scope:{session:"=session"},templateUrl:"scripts/directives/session-messages/session-messages.html",controller:["$scope","api","moment","auth","$firebaseArray",function(a,b,c,d,e){a.messages=b.getArray("messages"),a.addMessage=function(e){b.update("messages",{sender:d.getCurrentUser(),text:e,createdAt:c().valueOf(),session:a.session})}}]}}),angular.module("thereApp").directive("sessionUsers",function(){return{restrict:"EA",scope:{session:"=session"},templateUrl:"scripts/directives/session-users/session-users.html",controller:["$scope","api","moment","auth",function(a,b,c,d){}]}}),angular.module("thereApp").directive("headerAccount",function(){return{restrict:"EA",scope:{},templateUrl:"scripts/directives/header-account/header-account.html",controller:["$scope","api","moment","auth",function(a,b,c,d){a.$watch(function(){return d.getCurrentUser()},function(){a.currentUser=d.getCurrentUser()}),a.logout=function(){d.logout()}}]}}),angular.module("thereApp").run(["$templateCache",function(a){a.put("views/appointments.html",'<!-- <button class="btn btn-primary"ng-click="addApp()">Add Appointment</button>\n<button class="btn btn-primary"ng-click="addUser()">Add User</button> --> <div class="appointments-list-container"> <div ng-repeat="app in apps | orderBy: \'-startdate\' " class="appointment" ng-click="goToAppointment(app)"> <div class="appointment-profile-pic" ng-style="{\'background-image\': \'url(\' + app.imageurl + \')\'}"> </div> <div class="appointment-content"> <div class="row"> <span class="appointment-client col-xs-6">{{app.client}}</span> <span class="appointment-date col-xs-6">{{app.startdate | countdown}}</span> </div> <div class="row"> <span class="col-xs-12 appointment-details">{{app.description}}</span> </div> <div class="row"> <span class="col-xs-12 appointment-users"> <span ng-if="app.therapist">Therapist: {{app.therapist}} |</span> <span ng-if="app.interpreter">Interpreter: {{app.interpreter}}</span> </span> </div> </div> </div> </div>'),a.put("views/createapptmt.html",'<div class="create-apptmt-container"> <h3>Create A New Appointment</h3> <form> <div class="form-group"> <label for="exampleInputEmail1">Email address</label> <input type="email" class="form-control" id="exampleInputEmail1" placeholder="Email"> </div> <div class="form-group"> <label for="exampleInputPassword1">Password</label> <input type="password" class="form-control" id="exampleInputPassword1" placeholder="Password"> </div> <button type="submit" class="btn btn-default">Submit</button> </form> </div>'),a.put("views/login.html",'<div> <label>Username</label> <input id="username" type="text" ng-model="username"> <label>Password</label> <input id="password" type="text" ng-model="password"> <button ng-click="login(username, password)">Login</button> </div>'),a.put("views/people.html","<p>This is the people view.</p>"),a.put("views/session.html",'<div class="flex-container y-full"> <div class="video-container"> <div class="mainCamDiv-container"> <div id="mainCamDiv"></div> </div> <div class="myCamDiv-container"> <div id="myCamDiv"></div> </div> <div class="theirCamDiv-container"> <div id="theirCamDiv"></div> </div> </div> <div class="utility-sidebar"> <div class="utility-sidebar__wrapper"> <ul class="nav sidebar-tabs" role="tablist"> <li role="presentation" class="active"><a href="#profile" aria-controls="chat" role="tab" data-toggle="tab"> <i class="fa fa-comment"></i></a> </li> <li role="presentation"><a href="#messages" aria-controls="notes" role="tab" data-toggle="tab"> <i class="fa fa-file-text-o"></i></a> </li> <li role="presentation"><a href="#settings" aria-controls="activeusers" role="tab" data-toggle="tab"> <i class="fa fa-users"></i></a> </li> </ul> <!-- Tab panes --> <!-- <div class="tab-content">\n        <div role="tabpanel" class="tab-pane" id="chat">\n        </div>\n        <div role="tabpanel" class="tab-pane" id="notes">...</div>\n        <div role="tabpanel" class="tab-pane" id="activeusers">...</div>\n      </div> --> <uib-tabset active="active"> <uib-tab index="0"> <uib-tab-heading> <i class="glyphicon glyphicon-bell"></i> </uib-tab-heading> <session-messages session="session"></session-messages> </uib-tab> <uib-tab index="1"> <uib-tab-heading> <i class="glyphicon glyphicon-bell"></i> </uib-tab-heading> <session-notes session="session"></session-notes> </uib-tab> <uib-tab index="2"> <uib-tab-heading> <i class="glyphicon glyphicon-bell"></i> </uib-tab-heading> <session-users session="session"></session-users> </uib-tab>  </uib-tabset> </div> </div> </div>')}]);